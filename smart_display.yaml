substitutions:
  name: "guition-esp32-s3-4848s040"
  friendly_name: "Guition Smart Light Control"
  device_description: "Guition ESP32-S3-4848S040 Smart Light Controller"
  project_name: "Guition.ESP32_S3_4848S040"
  project_version: "1.0.2"

  lightbulb: "\U000F0335"
  ceiling_light: "\U000F0769"
  lamp: "\U000F06B5"
  floor_lamp: "\U000F08DD"
  string_lights: "\U000F12BA"
  settings_icon: "\U000F0493"
  home_icon: "\U000F02DC"
  sun_icon: "\U000F0599"
  moon_icon: "\U000F0F64"
  rain_icon: "\U000F0596"
  thermometer_icon: "\U000F050F"

esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"
  project:
    name: "${project_name}"
    version: "${project_version}"
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 16MB
  framework:
    type: esp-idf
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y

psram:
  mode: octal
  speed: 80MHz

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret encryption_key

ota:
  - platform: esphome
    id: my_ota
    password: !secret ota_password
    on_begin:
      then:
        - logger.log: "OTA start"
        - light.turn_on: backlight
        - lvgl.resume:
        - lvgl.widget.show: popup_obj
        - lvgl.resume:
        - lvgl.widget.redraw:
    on_progress:
        then:
          - lvgl.bar.update:
              id: popup_pb_percentage
              value: !lambda "return (int)x;"
          - lvgl.label.update:
              id: popup_lbl_percentage
              text:
                format: "OTA progress %0.1f%%"
                args: ["x"]
          - lambda: "id(lvgl_comp).loop();"  

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "PhiJo Smart Products Fallback"
    password: !secret wifi_fallback_password
  on_connect:
    then:
      - logger.log: "WiFi connected, starting web server"
      #- component.update: web_servers  # Changed from web_server to web_servers
      - delay: 1s
      - script.execute: notify_web_portal
  on_disconnect:
    then:
      - script.execute: notify_web_portal

time:
  - platform: homeassistant
    id: time_comp
    on_time_sync:
      - script.execute: time_update
    on_time:
      # Update clock display every minute
      - minutes: '*'
        seconds: 0
        then:
          - script.execute: time_update
      
      # Check for sunrise/sunset events and other automations
      - seconds: 0
        minutes: /1
        then:
          - script.execute: check_light_schedules

web_server:
  port: 80

captive_portal:


# For the sun component, we need to use fixed values initially
sun:
  latitude: 37.1  # Default value matching the initial_value in location_latitude
  longitude: -8.0  # Default value matching the initial_value in location_longitude
  id: sun_comp

# Add this to update the sun component when location changes
number:
  - platform: template
    id: location_latitude
    name: "Location Latitude"
    min_value: -90
    max_value: 90
    step: 0.01
    restore_value: true
    initial_value: 37.1  # Default to a central location
    optimistic: true
    on_value:
      then:
        - lambda: |-
            id(sun_comp).set_latitude(id(location_latitude).state);
    
  - platform: template
    id: location_longitude
    name: "Location Longitude"
    min_value: -180
    max_value: 180
    step: 0.01
    restore_value: true
    initial_value: -8.0  # Default to a central location
    optimistic: true
    on_value:
      then:
        - lambda: |-
            id(sun_comp).set_longitude(id(location_longitude).state);

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address"
      id: ip_address
      entity_category: diagnostic
      on_value:
        then:
          - lvgl.label.update:
              id: ip_address_label
              text:
                format: "%s"
                args: [ 'id(ip_address).get_state().c_str()' ]
    ssid:
      name: "Connected SSID"
      entity_category: diagnostic
    mac_address:
      name: "Mac Address"
      entity_category: diagnostic
      
  - platform: template
    id: location_name
    name: "Weather Location"
    lambda: |-
      return {id(location_name_str)};

color:
  # Create a Home Assistant blue color
  - id: ha_blue
    hex: 51c0f2
  - id: green_color
    red: 0%
    green: 60%
    blue: 0%
  - id: red_color
    red: 80%
    green: 0%
    blue: 0%
  - id: orange_color
    red: 100%
    green: 60%
    blue: 0%
  - id: blue_color
    red: 0%
    green: 40%
    blue: 100%

# Global variables for timer tracking and settings
globals:
  - id: location_name_str
    type: std::string
    restore_value: yes
    initial_value: '"Sao Bartolomeu de Messines, Portugal"'
  # Timer tracking
  - id: sw1_off_time
    type: int
    restore_value: yes
    initial_value: "0"
  - id: sw2_off_time
    type: int
    restore_value: yes
    initial_value: "0"
  - id: sw3_off_time
    type: int
    restore_value: yes
    initial_value: "0"
  - id: sw1_before_sunrise
    type: bool
    restore_value: yes
    initial_value: "false"
    
  # Manual override tracking
  - id: sw1_manual_override_time
    type: int
    restore_value: yes
    initial_value: "0"
  - id: sw2_manual_override_time
    type: int
    restore_value: yes
    initial_value: "0"
  - id: sw3_manual_override_time
    type: int
    restore_value: yes
    initial_value: "0"
    
  # SW3 mode (winter/summer)
  - id: sw3_winter_mode
    type: bool
    restore_value: yes
    initial_value: "false"  # Default to summer mode
    
  # Current page tracking
  - id: current_page
    type: int
    restore_value: no
    initial_value: "0"  # 0 = main page, 1 = settings page

#-------------------------------------------
# LVGL Interface
#-------------------------------------------
lvgl:
  id: lvgl_comp
  displays:
    - my_display
  touchscreens:
    - touchscreen_id: my_touchscreen
  on_idle:
    - timeout: 15s
      then:
        - logger.log: idle 15s timeout
        - light.turn_off:
            id: backlight
            transition_length: 5s
        - lvgl.pause:
            show_snow: true

  style_definitions:
    - id: style_line
      line_color: 0x0000FF
      line_width: 8
      line_rounded: true
    - id: date_style
      text_font: roboto24
      align: center
      text_color: 0x333333
      bg_opa: cover
      radius: 4
      pad_all: 2
    - id: switch_style_on
      bg_color: 0x00AA00
      text_color: 0xFFFFFF
    - id: switch_style_off
      bg_color: 0x555555
      text_color: 0xCCCCCC
    - id: nav_button_style
      bg_color: 0x444444
      text_color: 0xFFFFFF
      radius: 15
      pad_all: 5

  theme:
    button:
      text_font: roboto24
      scroll_on_focus: true
      radius: 25
      width: 150
      height: 109
      pad_left: 10px
      pad_top: 10px
      pad_bottom: 10px
      pad_right: 10px
      shadow_width: 0
      bg_color: 0x313131
      text_color: 0xB6B6B6
      checked:
        bg_color: 0xCC5E14
        text_color: 0xB6B6B6

  page_wrap: true
  pages:
    # Main Page
    - id: main_page
      skip: false
      layout:
        type: flex
        flex_flow: column_wrap
      width: 100%
      bg_color: 0x000000
      bg_opa: cover
      pad_all: 5
      widgets:
        # Title bar
        - obj:
            width: 100%
            height: 60
            bg_color: ha_blue
            bg_opa: cover
            widgets:
              - label:
                  text: "Smart Light Control"
                  text_font: roboto24
                  align: center
                  text_color: 0xFFFFFF
              # - button:
              #     id: settings_button
              #     x: 420
              #     y: 10
              #     width: 40
              #     height: 40
              #     styles: nav_button_style
              #     widgets:
              #       - label:
              #           text: "${settings_icon}"
              #           text_font: icons24
              #           align: center
              #     on_click:
              #       then:
              #         - lambda: |-
              #             id(current_page) = 1;
              #         - lvgl.widget.show: settings_page
                        
        # Clock display
        - meter:
            height: 300
            width: 300
            align: center
            x: 0
            y: 0
            widgets:
            bg_opa: TRANSP
            text_color: 0xFFFFFF
            scales:
              - ticks:
                  width: 1
                  count: 61
                  length: 10
                  color: 0xFFFFFF
                range_from: 0
                range_to: 60
                angle_range: 360
                rotation: 270
                indicators:
                  - line:
                      id: minute_hand
                      value: !lambda |-
                        return id(time_comp).now().minute;
                      width: 3
                      color: 0xE0E0E0
                      r_mod: -1
              -
                angle_range: 330
                rotation: 300
                range_from: 1
                range_to: 12
                ticks:
                  width: 1
                  count: 12
                  length: 1
                  major:
                    stride: 1
                    width: 4
                    length: 8
                    color: 0xC0C0C0
                    label_gap: 6

              - angle_range: 360
                rotation: 270
                range_from: 0
                range_to: 720
                indicators:
                  - line:
                      id: hour_hand
                      value: !lambda |-
                        auto now = id(time_comp).now();
                        return std::fmod(now.hour, 12) * 60 + now.minute;
                      width: 4
                      color: 0xA0A0A0
                      r_mod: -20
        
        # Date display
        - obj:
            align: center
            x: 0
            y: 150
            widgets:
            - label:
                styles: date_style
                id: day_label
                y: -20
                text: !lambda |-
                  static const char * const day_names[] = {"SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"};
                  return day_names[id(time_comp).now().day_of_week - 1];
            - label:
                styles: date_style
                id: date_label
                y: +20
                text: !lambda |-
                  static const char * const mon_names[] = {"JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"};
                  static char date_buf[8];
                  auto now = id(time_comp).now();
                  snprintf(date_buf, sizeof(date_buf), "%s %2d", mon_names[now.month-1], now.day_of_month);
                  return date_buf;
        
        # Weather info display
        - obj:
            width: 90%
            height: 60
            widgets:
              - label:
                  id: weather_label
                  text: "Loading weather data..."
                  text_color: 0xCCCCCC
                  align: center
        
        # Switch 1 - Sunrise/Sunset Light
        - button:
            id: sw1_button
            width: 90%
            height: 80
            checkable: true
            widgets:
              - label:
                  text: "${sun_icon} Sunrise/Sunset Light"
                  text_font: roboto24
                  align: center
            on_click:
              then:
                - switch.toggle: sw1
                - lambda: |-
                    id(sw1_manual_override_time) = id(time_comp).now().timestamp;
            
        # Switch 2 - Seasonal Daytime Light
        - button:
            id: sw2_button
            width: 90%
            height: 80
            checkable: true
            widgets:
              - label:
                  text: "${thermometer_icon} Seasonal Daytime Light"
                  text_font: roboto24
                  align: center
            on_click:
              then:
                - switch.toggle: sw2
                - lambda: |-
                    id(sw2_manual_override_time) = id(time_comp).now().timestamp;
                
        # Switch 3 - Weather-Based Light
        - button:
            id: sw3_button
            width: 90%
            height: 80
            checkable: true
            widgets:
              - label:
                  id: sw3_button_label
                  text: !lambda |-
                    if (id(sw3_winter_mode)) {
                      return " Weather-Based Light (Winter)";
                    } else {
                      return "Weather-Based Light (Summer)";
                    }
                  text_font: roboto24
                  align: center
            on_click:
              then:
                - switch.toggle: sw3
                - lambda: |-
                    id(sw3_manual_override_time) = id(time_comp).now().timestamp;
                
        # Status display
        - obj:
            width: 90%
            height: 60
            widgets:
              - label:
                  id: status_label
                  text: "Ready"
                  text_color: 0xCCCCCC
                  align: center
                  
        # IP Address display
        - obj:
            widgets:
            - label:
                id: ip_address_label
                align: CENTER
                text: 'wifi Not connected, Loading ...'
                text_color: ha_blue
                y: +10
    
    # Settings Page
    - id: settings_page
      hidden: true
      layout:
        type: flex
        flex_flow: column_wrap
      width: 100%
      bg_color: 0x000000
      bg_opa: cover
      pad_all: 5
      widgets:
        # Title bar
        - obj:
            width: 100%
            height: 60
            bg_color: ha_blue
            bg_opa: cover
            widgets:
              - label:
                  text: "Settings"
                  text_font: roboto24
                  align: center
                  text_color: 0xFFFFFF
              - button:
                  id: home_button
                  x: 420
                  y: 10
                  width: 40
                  height: 40
                  styles: nav_button_style
                  widgets:
                    - label:
                        text: "${home_icon}"
                        text_font: icons24
                        align: center
                  on_click:
                    then:
                      - lambda: |-
                          id(current_page) = 0;
                      - lvgl.widget.update:
                          id: settings_page
                          hidden: true
                      - lvgl.widget.update:
                          id: main_page
                          hidden: false
        
        # Location settings
        - obj:
            width: 100%
            height: 40
            widgets:
              - label:
                  text: "Location Settings"
                  text_font: roboto24
                  align: center
                  text_color: 0xFFFFFF
                  
        - obj:
            width: 90%
            height: 60
            widgets:
              - label:
                  text: "Location Name:"
                  text_font: roboto24
                  x: 10
                  y: 20
                  text_color: 0xCCCCCC
              - label:
                  id: location_name_label
                  text: !lambda 'return id(location_name).state;'
                  text_font: roboto24
                  x: 240
                  y: 20
                  text_color: 0xFFFFFF
                  
        - obj:
            width: 90%
            height: 60
            widgets:
              - label:
                  text: "Latitude:"
                  text_font: roboto24
                  x: 10
                  y: 20
                  text_color: 0xCCCCCC
              - label:
                  id: latitude_label
                  text: !lambda 'return std::to_string(id(location_latitude).state);'
                  text_font: roboto24
                  x: 240
                  y: 20
                  text_color: 0xFFFFFF
                  
        - obj:
            width: 90%
            height: 60
            widgets:
              - label:
                  text: "Longitude:"
                  text_font: roboto24
                  x: 10
                  y: 20
                  text_color: 0xCCCCCC
              - label:
                  id: longitude_label
                  text: !lambda 'return std::to_string(id(location_longitude).state);'
                  text_font: roboto24
                  x: 240
                  y: 20
                  text_color: 0xFFFFFF
        
        # SW3 Mode Toggle
        - button:
            id: sw3_mode_toggle
            width: 90%
            height: 80
            checkable: true
            state:
              checked: !lambda 'return id(sw3_winter_mode);'
            widgets:
              - label:
                  id: sw3_mode_label
                  text: !lambda |-
                    if (id(sw3_winter_mode)) {
                      return "SW3 Mode: Winter (Rain-based)";
                    } else {
                      return "SW3 Mode: Summer (Temperature-based)";
                    }
                  text_font: roboto24
                  align: center
                  # For the SW3 mode toggle
                  on_click:
                    then:
                      - lambda: |-
                          id(sw3_winter_mode) = !id(sw3_winter_mode);
                      - if:
                          condition:
                            lambda: 'return id(sw3_winter_mode);'
                          then:
                            - lvgl.label.update:
                                id: sw3_mode_label
                                text: "SW3 Mode: Winter (Rain-based)"
                            - lvgl.label.update:
                                id: sw3_button_label
                                text: " Weather-Based Light (Winter)"
                          else:
                            - lvgl.label.update:
                                id: sw3_mode_label
                                text: "SW3 Mode: Summer (Temperature-based)"
                            - lvgl.label.update:
                                id: sw3_button_label
                                text: "Weather-Based Light (Summer)"

        # System Info
        - obj:
            width: 100%
            height: 40
            widgets:
              - label:
                  text: "System Information"
                  text_font: roboto24
                  align: center
                  text_color: 0xFFFFFF
                  
        - obj:
            width: 90%
            height: 60
            widgets:
              - label:
                  text: "WiFi Signal:"
                  text_font: roboto24
                  x: 10
                  y: 20
                  text_color: 0xCCCCCC
              - label:
                  id: wifi_signal_label
                  text: "Unknown"
                  text_font: roboto24
                  x: 240
                  y: 20
                  text_color: 0xFFFFFF
                  
        - obj:
            width: 90%
            height: 60
            widgets:
              - label:
                  text: "IP Address:"
                  text_font: roboto24
                  x: 10
                  y: 20
                  text_color: 0xCCCCCC
              - label:
                  id: settings_ip_label
                  text: !lambda 'return id(ip_address).state;'
                  text_font: roboto24
                  x: 240
                  y: 20
                  text_color: 0xFFFFFF
                  
        - obj:
            width: 90%
            height: 60
            widgets:
              - label:
                  text: "Version:"
                  text_font: roboto24
                  x: 10
                  y: 20
                  text_color: 0xCCCCCC
              - label:
                  text: "${project_version}"
                  text_font: roboto24
                  x: 240
                  y: 20
                  text_color: 0xFFFFFF
                  
        # OTA popup (shared between pages)
        - obj:
            id: popup_obj
            hidden: true
            clickable: false
            x: 0
            y: 0
            width: 100%
            height: 100%
            pad_all: 10
            bg_opa: cover
            widgets:
              - label:
                  id: lbl_popup_title
                  x: 2
                  y: 2
                  text: "OTA in progress"
              - label:
                  id: popup_lbl_percentage
                  x: 2
                  y: 30
                  width: 100%
                  text: "0 %"
              - bar:
                  id: popup_pb_percentage
                  x: 2
                  y: 60
                  width: 100%
                  height: 10
                  max_value: 100
                  min_value: 0
                  value: 0

#-------------------------------------------
# Internal outputs
#-------------------------------------------
output:
  # Backlight LED
  - platform: ledc
    pin: GPIO38
    id: GPIO38
    frequency: 100Hz

  # Built in 240v relay
  - id: internal_relay_1
    platform: gpio
    pin: 40

  # Additional relays (3 relay model)
  - id: internal_relay_2
    platform: gpio
    pin: 2
  - id: internal_relay_3
    platform: gpio
    pin: 1

#-------------------------------------------
# Internal lights and switches
#-------------------------------------------
light:
  - platform: monochromatic
    output: GPIO38
    name: Backlight
    id: backlight
    restore_mode: ALWAYS_ON

switch:
  - platform: output
    id: sw1
    name: "Sunrise/Sunset Light"
    output: internal_relay_1
    on_turn_on:
      then:
        - lvgl.widget.update:
            id: sw1_button
            state:
              checked: true
        - lvgl.label.update:
            id: status_label
            text: "Sunrise/Sunset Light ON"
            text_color: green_color
    on_turn_off:
      then:
        - lvgl.widget.update:
            id: sw1_button
            state:
              checked: false
        - lvgl.label.update:
            id: status_label
            text: "Sunrise/Sunset Light OFF"
            text_color: red_color
            
  - platform: output
    id: sw2
    name: "Seasonal Daytime Light"
    output: internal_relay_2
    on_turn_on:
      then:
        - lvgl.widget.update:
            id: sw2_button
            state:
              checked: true
        - lvgl.label.update:
            id: status_label
            text: "Seasonal Daytime Light ON"
            text_color: green_color
    on_turn_off:
      then:
        - lvgl.widget.update:
            id: sw2_button
            state:
              checked: false
        - lvgl.label.update:
            id: status_label
            text: "Seasonal Daytime Light OFF"
            text_color: red_color
            
  - platform: output
    id: sw3
    name: "Weather-Based Light"
    output: internal_relay_3
    on_turn_on:
      then:
        - lvgl.widget.update:
            id: sw3_button
            state:
              checked: true
        - lvgl.label.update:
            id: status_label
            text: !lambda |-
              if (id(sw3_winter_mode)) {
                return "Weather-Based Light ON (Winter)";
              } else {
                return "Weather-Based Light ON (Summer)";
              }
            text_color: green_color
    on_turn_off:
      then:
        - lvgl.widget.update:
            id: sw3_button
            state:
              checked: false
        - lvgl.label.update:
            id: status_label
            text: !lambda |-
              if (id(sw3_winter_mode)) {
                return "Weather-Based Light OFF (Winter)";
              } else {
                return "Weather-Based Light OFF (Summer)";
              }
            text_color: red_color

#-------------------------------------------
# Scripts for automation logic
#-------------------------------------------
script:
  - id: notify_web_portal
    then:
      - if:
          condition:
            wifi.connected:
          then:
            - lvgl.label.update:
                id: status_label
                text: "Web portal active at http://${ip_address.state}"
                text_color: ha_blue
            - logger.log: 
                format: "Web portal active at http://%s"
                args: ['id(ip_address).state.c_str()']
          else:
            - lvgl.label.update:
                id: status_label
                text: "No internet. Connect to AP: PhiJo Smart Products"
                text_color: orange_color
            - logger.log: "No internet. Connect to AP: PhiJo Smart Products"
      - lvgl.label.update:
          id: ip_address_label
          text: !lambda |-
            if (id(ip_address).has_state()) {
              return std::string("WiFi: ") + id(ip_address).state;
            } else {
              return "wifi Not connected";
            }

  - id: time_update
    # update the clock display
    then:
      - script.execute: notify_web_portal
      - lvgl.indicator.update:
          id: minute_hand
          value: !lambda |-
            return id(time_comp).now().minute;
      - lvgl.indicator.update:
          id: hour_hand
          value: !lambda |-
            auto now = id(time_comp).now();
            return std::fmod(now.hour, 12) * 60 + now.minute;
      - lvgl.label.update:
          id: date_label
          text: !lambda |-
            static const char * const mon_names[] = {"JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"};
            static char date_buf[8];
            auto now = id(time_comp).now();
            snprintf(date_buf, sizeof(date_buf), "%s %2d", mon_names[now.month-1], now.day_of_month);
            return date_buf;
      - lvgl.label.update:
          id: day_label
          text: !lambda |-
            static const char * const day_names[] = {"SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"};
            return day_names[id(time_comp).now().day_of_week - 1];
      - lvgl.label.update:
          id: weather_label
          text: "Weather data unavailable"
            
  - id: check_light_schedules
    then:
      - lambda: |-
          auto now = id(time_comp).now();
          
          // Check for manual override timeouts (24 hours = 86400 seconds)
          if (id(sw1_manual_override_time) > 0 && 
              now.timestamp - id(sw1_manual_override_time) > 86400) {
            id(sw1_manual_override_time) = 0;
          }
          
          if (id(sw2_manual_override_time) > 0 && 
              now.timestamp - id(sw2_manual_override_time) > 86400) {
            id(sw2_manual_override_time) = 0;
          }
          
          if (id(sw3_manual_override_time) > 0 && 
              now.timestamp - id(sw3_manual_override_time) > 86400) {
            id(sw3_manual_override_time) = 0;
          }
          
          // Only run automations if not in manual override mode
          
          // ---- SWITCH 1: SUNRISE/SUNSET CONTROL ----
          if (id(sw1_manual_override_time) == 0) {
            // Check for sunrise events
            auto sunrise_opt = id(sun_comp).sunrise(0.0);  // 0.0 degrees elevation
            if (sunrise_opt.has_value()) {
              auto sunrise = sunrise_opt.value();
              
              // Check if it's 30 minutes before sunrise (between 30 and 29 minutes before)
              if (sunrise.timestamp - now.timestamp <= 1800 && 
                  sunrise.timestamp - now.timestamp > 1740 && 
                  !id(sw1_before_sunrise)) {
                // Turn on light 30 minutes before sunrise
                id(sw1).turn_on();
                id(sw1_before_sunrise) = true;
                id(lvgl_comp).loop();
              }
              
              // Check if it's sunrise time (within 1 minute)
              if (abs(sunrise.timestamp - now.timestamp) < 60 && 
                  id(sw1_before_sunrise)) {
                // Turn off light at sunrise
                id(sw1).turn_off();
                id(sw1_before_sunrise) = false;
                id(lvgl_comp).loop();
              }
            }
            
            // Check for sunset events
            auto sunset_opt = id(sun_comp).sunset(0.0);  // 0.0 degrees elevation
            if (sunset_opt.has_value()) {
              auto sunset = sunset_opt.value();
              
              // Check if it's sunset time (within 1 minute)
              if (abs(sunset.timestamp - now.timestamp) < 60) {
                // Turn on light at sunset and set timer for 2 hours
                id(sw1).turn_on();
                id(sw1_off_time) = now.timestamp + 7200; // 2 hours
                id(lvgl_comp).loop();
              }
            }
            
            // Check if it's time to turn off SW1 after sunset
            if (id(sw1).state && !id(sw1_before_sunrise) && 
                now.timestamp >= id(sw1_off_time) && id(sw1_off_time) > 0) {
              id(sw1).turn_off();
              id(sw1_off_time) = 0;
              id(lvgl_comp).loop();
            }
          }
          
          // ---- SWITCH 2: SEASONAL DAYTIME CONTROL ----
          if (id(sw2_manual_override_time) == 0) {
            // Run the seasonal timer at noon
            if (now.hour == 12 && now.minute == 0) {
              int month = now.month;
              // Summer: Mar-Sep (6 hours), Winter: Oct-Feb (1 hour)
              int hours = (month >= 3 && month <= 9) ? 6 : 1;
              
              // Turn on SW2 and set timer
              id(sw2).turn_on();
              id(sw2_off_time) = now.timestamp + hours * 3600;
              id(lvgl_comp).loop();
            }
            
            // Check if it's time to turn off SW2
            if (id(sw2).state && now.timestamp >= id(sw2_off_time) && id(sw2_off_time) > 0) {
              id(sw2).turn_off();
              id(sw2_off_time) = 0;
              id(lvgl_comp).loop();
            }
          }
          
          // ---- SWITCH 3: WEATHER-BASED CONTROL ----
          // For now, we'll just use a simple timer for SW3 without weather data
          if (id(sw3_manual_override_time) == 0) {
            // Turn on SW3 at 3 PM if it's not already on
            if (now.hour == 15 && now.minute == 0 && !id(sw3).state) {
              id(sw3).turn_on();
              id(sw3_off_time) = now.timestamp + 3600; // 1 hour
              id(lvgl_comp).loop();
            }
            
            // Check if it's time to turn off SW3
            if (id(sw3).state && now.timestamp >= id(sw3_off_time) && id(sw3_off_time) > 0) {
              id(sw3).turn_off();
              id(sw3_off_time) = 0;
              id(lvgl_comp).loop();
            }
          }

#-------------------------------------------
# Graphics and Fonts
#-------------------------------------------
font:
  - file: "gfonts://Roboto"
    id: roboto24
    size: 24
    bpp: 4
    
  - file: "gfonts://Roboto"
    id: roboto
    size: 18
    bpp: 4

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons24
    size: 24
    bpp: 4
    glyphs: [
        "\U000F0335", # mdi-lightbulb
        "\U000F0769", # mdi-ceiling-light
        "\U000F06B5", # mdi-lamp
        "\U000F08DD", # mdi-floor-lamp
        "\U000F12BA", # mdi-string-lights
        "\U000F0493", # mdi-settings
        "\U000F02DC", # mdi-home
        "\U000F0599", # mdi-weather-sunny
        "\U000F0F64", # mdi-weather-night
        "\U000F0596", # mdi-weather-pouring
        "\U000F050F", # mdi-thermometer
      ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: light40
    size: 40
    bpp: 4
    glyphs: [
        "\U000F0335", # mdi-lightbulb
        "\U000F0769", # mdi-ceiling-light
        "\U000F06B5", # mdi-lamp
        "\U000F08DD", # mdi-floor-lamp
        "\U000F12BA", # mdi-string-lights
      ]

#-------------------------------------------
# Touchscreen gt911 i2c
#-------------------------------------------
i2c:
  - id: bus_a
    sda: GPIO19
    scl: GPIO45

touchscreen:
  platform: gt911
  transform:
    mirror_x: false
    mirror_y: false
  id: my_touchscreen
  display: my_display

  on_touch:
    - lambda: |-
        ESP_LOGD("touch", "Touch at (%d, %d)", touch.x, touch.y);
  on_release:
    then:
      - if:
          condition: lvgl.is_paused
          then:
            - light.turn_on: backlight
            - lvgl.resume:
            - lvgl.widget.redraw:

#-------------------------------------------
# Display st7701s spi
#-------------------------------------------
spi:
  - id: lcd_spi
    clk_pin: GPIO48
    mosi_pin: GPIO47

display:
  - platform: st7701s
    id: my_display
    update_interval: never
    auto_clear_enabled: False
    spi_mode: MODE3
    color_order: RGB
    invert_colors: False
    dimensions:
      width: 480
      height: 480
    cs_pin: 39
    de_pin: 18
    hsync_pin: 16
    vsync_pin: 17
    pclk_pin: 21
    pclk_frequency: 12MHz
    pclk_inverted: False
    hsync_pulse_width: 8
    hsync_front_porch: 10
    hsync_back_porch: 20
    vsync_pulse_width: 8
    vsync_front_porch: 10
    vsync_back_porch: 10
    init_sequence:
      - 1
      # Custom sequences are an array, first byte is command, the rest are data.
      - [0xFF, 0x77, 0x01, 0x00, 0x00, 0x10] # CMD2_BKSEL_BK0
      - [0xCD, 0x00] # disable MDT flag
    data_pins:
      red:
        - 11 #r1
        - 12 #r2
        - 13 #r3
        - 14 #r4
        - 0 #r5
      green:
        - 8 #g0
        - 20 #g1
        - 3 #g2
        - 46 #g3
        - 9 #g4
        - 10 #g5
      blue:
        - 4 #b1
        - 5 #b2
        - 6 #b3
        - 7 #b4
        - 15 #b5